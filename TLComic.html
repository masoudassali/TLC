<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link href="https://fonts.googleapis.com/css2?family=Amatic+SC:wght@400;700&family=Handlee&display=swap" rel="stylesheet">
    <title>The Lined Canvas - New Yorker Daily Cartoon Generator</title>
    <style>
        /* General Styling */
        body {
            font-family: 'Handlee', cursive;
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            line-height: 1.25;
        }

        /* Container for the App */
        .generator-container {
            background-color: #fff;
            padding: 40px;
            border-radius: 12px;
            max-width: 900px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 30px;
            position: relative;
            box-sizing: border-box;
        }

        /* ------------------------------------------- */
        /* HEADER SECTION WITH BACKGROUND IMAGE (Minimal changes from original) */
        /* ------------------------------------------- */
        .header-section {
            margin: -40px -40px 30px -40px;
            padding: 40px 40px 20px 40px;
            background-image: url('https://raw.githubusercontent.com/masoudassali/TLC/refs/heads/main/Header.jpg');
            background-size: cover;
            background-position: 50% 35%;
            background-repeat: no-repeat;
            height: 180px;
            position: relative; 
            border-radius: 12px 12px 0 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
        }

        .header-text-highlight {
            background-color: rgba(240, 240, 240, 0.95);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 5px 10px;
            line-height: 1;
            box-decoration-break: clone;
            display: inline-block;
        }

        .logo-container {
            position: absolute;
            top: 30px;
            right: 30px;
            z-index: 10;
        }

        .logo-container img {
            width: 80px;
            height: auto;
            filter: none;
            display: block;
        }

        .header-section h1 {
            font-family: 'Amatic SC', cursive;
            color: #222;
            text-align: center;
            margin-top: 5px;
            margin-bottom: 0;
            font-weight: 700;
            font-size: 3.8em;
            padding-right: 0;
            padding-left: 0;
            line-height: 1.2;
            text-shadow: none;
        }

        .header-section .subtitle {
            color: #444;
            text-align: center;
            margin-top: 5px;
            margin-bottom: 0;
            font-style: normal;
            font-size: 2.2em;
            line-height: 1.2;
            padding-right: 0;
            padding-left: 0;
            text-shadow: none;
        }
        /* ------------------------------------------- */
        /* END HEADER SECTION STYLES */
        /* ------------------------------------------- */

        /* Simplified Form Styling */
        .prompt-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
            box-sizing: border-box;
        }

        .prompt-form label {
            font-size: 1.5em;
            color: #5D4037;
            margin: 0;
            line-height: 1.1;
        }

        /* --- New Yorker Specific Display --- */
        .new-yorker-info {
            padding: 15px 20px;
            background-color: #fff9f5;
            border: 2px solid #E64A19;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
        }
        .new-yorker-info h3 {
            font-size: 2em;
            color: #E64A19;
            margin: 0 0 5px 0;
        }
        .new-yorker-info p {
            font-size: 1.3em;
            color: #5D4037;
            margin: 5px 0;
        }

        /* --- Three Images Preview Section --- */
        .images-preview-section {
            display: flex;
            justify-content: space-around;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .image-box {
            width: 150px;
            height: 150px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .image-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .image-box-placeholder {
            font-size: 0.9em;
            color: #9E9E9E;
            text-align: center;
            padding: 10px;
        }
        /* ----------------------------------- */


        button {
            background-color: #FF7043;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.8em;
            font-weight: bold;
            transition: background-color 0.3s;
            font-family: 'Handlee', cursive;
            line-height: 1;
            margin-top: 0;
        }

        button:hover {
            background-color: #E64A19;
        }

        /* Centering the generate button */
        .submit-button-wrapper {
            margin-top: 20px;
            text-align: center;
        }
        
        /* Chef Tony Info Section (Kept for branding) */
        .chef-tony-info {
            padding: 10px 0;
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .chef-tony-info p {
            font-size: 1.3em;
            color: #5D4037;
            font-weight: bold;
            margin-top: 0;
            margin-bottom: 10px;
        }
        .chef-tony-images {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .chef-tony-images img {
            width: 120px;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border: 2px solid #FF7043;
        }

        /* Status Bar Styling */
        .status-bar {
            text-align: center;
            min-height: 20px;
            margin-top: -15px;
            color: #FF7043;
            font-size: 1.5em;
            font-weight: 700;
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            font-family: 'Handlee', cursive;
            line-height: 1;
        }

        .status-bar.visible {
            opacity: 1;
        }

        /* Image Display Area */
        .image-display {
            border: 2px dashed #BDBDBD;
            border-radius: 8px;
            min-height: 350px;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            background-color: #FAFAFA;
            box-sizing: border-box;
        }

        .image-placeholder {
            color: #9E9E9E;
            font-style: italic;
            font-size: 1.5em;
            font-family: 'Handlee', cursive;
            line-height: 1.25;
        }

        .generated-image {
            max-width: 100%;
            max-height: 350px;
            border-radius: 6px;
            display: none;
        }

        /* Responsive tweaks */
        @media (max-width: 600px) {
            .header-section h1 { font-size: 2.8em; padding-right: 0; margin-top: 5px; }
            .header-section .subtitle { font-size: 1.6em; padding-right: 0; } 
            
            .images-preview-section {
                flex-direction: column;
                align-items: center;
            }
            .image-box {
                width: 100%;
                max-width: 250px;
                height: 250px;
            }
        }

        /* Logo above title for small screens (5in = 480px) */
        @media (max-width: 5in) {
            .generator-container { padding: 20px; gap: 20px; }
            .header-section {
                height: auto;
                padding: 20px 20px 5px 20px;
                margin: -20px -20px 20px -20px;
            }
            .logo-container {
                position: static;
                margin: 0px auto 10px auto;
                right: auto;
                top: auto;
            }
            .header-section h1 {
                margin-top: 0;
            }
            .chef-tony-images {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="generator-container">
        <div class="header-section">
            <div class="logo-container">
                <img src="https://raw.githubusercontent.com/masoudassali/TLC/refs/heads/main/TLC%20Logo.png" alt="The Lined Canvas Logo">
            </div>
            <h1>
                <span class="header-text-highlight">The Lined Canvas AI Studio</span>
            </h1>
            <p class="subtitle">
                <span class="header-text-highlight">Chef Tony cooks up a daily comic!</span>
            </p>
        </div>
        
        <div class="new-yorker-info">
            <h3>New Feature: Daily Comic Generator</h3>
            <p>Chef Tony takes **3 random images** from our gallery, analyzes their themes and content, and combines them into a single, cohesive comic panel in the style of **The New Yorker's Daily Cartoon**.</p>
        </div>

        <form class="prompt-form" id="imageGenerationForm">
            
            <label style="font-size: 1.5em; text-align: center;">The 3 images Chef Tony will analyze:</label>
            <div class="images-preview-section" id="imagesPreviewSection">
                <div class="image-box"><div class="image-box-placeholder">Image 1 Loading...</div></div>
                <div class="image-box"><div class="image-box-placeholder">Image 2 Loading...</div></div>
                <div class="image-box"><div class="image-box-placeholder">Image 3 Loading...</div></div>
            </div>

            <div class="submit-button-wrapper">
                <button type="submit" id="generateButton">Cook New Daily Comic Now!</button>
                <p style="font-size: 0.8em; color: #757575; margin-top: 5px;">
                    Disclaimer: Chef Tony is an AI agent. Randomness is in his nature.
                </p>
            </div>
        </form>

        <div class="chef-tony-info">
            <p>Who is Chef Tony?</p>
            <ol>Chef Tony is our chubbily cute and friendly "AI Chef" who cooks up creative outlines.</ol>
            <div class="chef-tony-images">
                <img src="https://raw.githubusercontent.com/masoudassali/TLC/main/Chef_Tony_3D.png" alt="Chef Tony 3D Illustration">
                <img src="https://raw.githubusercontent.com/masoudassali/TLC/main/Chef_Tony_Flatt.png" alt="Chef Tony Flat Illustration">
            </div>
        </div>
        
        <hr style="border: 0; height: 1px; background-image: linear-gradient(to right, rgba(0, 0, 0, 0), #FF7043, rgba(0, 0, 0, 0));">
        <div class="status-bar" id="statusBar">
            <span id="statusMessage"></span>
        </div>
        <h2>Your Generated Comic Preview</h2>
        <div class="image-display">
            <p class="image-placeholder" id="placeholderText">Chef Tony is cooking. It'd show up here once he's done.</p>
            <img src="" alt="AI Generated Comic" class="generated-image" id="generatedImage">
        </div>
    </div>
    <script>
        // *** CORE CONFIG & DOM ELEMENTS ***
        // NOTE: The n8n webhook URL remains the same, but its EXPECTED INPUT TYPE must change to JSON on the server side.
        const N8N_WEBHOOK_URL = 'https://steak.servequake.com/webhook/0d799bc0-9a8f-4da0-a9a0-39e511d5d01d'; 
        
        // Hardcoded list of potential image URLs to simulate a gallery
        const POTENTIAL_IMAGE_URLS = [
            'https://picsum.photos/id/684/200/200',
            'https://picsum.photos/id/1025/200/200',
            'https://picsum.photos/id/1080/200/200',
            'https://picsum.photos/id/30/200/200',
            'https://picsum.photos/id/56/200/200',
            'https://picsum.photos/id/169/200/200',
            'https://picsum.photos/id/40/200/200',
            'https://picsum.photos/id/80/200/200',
            'https://picsum.photos/id/100/200/200',
            // Add more URLs as needed for variety
        ];
        
        // Fixed style for the new project
        const NEW_YORKER_STYLE_PROMPT = "The final output must be a single, simple, black and white comic panel in the style of The New Yorker's Daily Cartoon. Analyze the three provided images for their main subject, theme, or concept, and combine these elements into a single, slightly humorous or ironic scene. Focus on clear outlines and minimal detail to capture the iconic New Yorker aesthetic.";
        
        // Wrap initialization so it runs after DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('imageGenerationForm');
            const placeholderText = document.getElementById('placeholderText');
            const generatedImage = document.getElementById('generatedImage');
            const generateButton = document.getElementById('generateButton');
            const statusBar = document.getElementById('statusBar');
            const statusMessage = document.getElementById('statusMessage');
            const imagesPreviewSection = document.getElementById('imagesPreviewSection');

            // Status Bar Steps (Adjusted for the new workflow)
            const STATUS_STEPS = [
                "5% - Selecting 3 random images for analysis...",
                "18% - Chef Tony is analyzing the content of the three images...",
                "35% - Combining concepts for a single comic scene...",
                "50% - Sketching the New Yorker style panel...",
                "67% - This may take 5-15 seconds...",
                "93% - Sending image data back to your browser...",
                "100% - Serving up your daily comic now..."
            ];

            // Status Bar Control
            let statusInterval;

            function updateStatus(start) {
                if (!start) {
                    clearInterval(statusInterval);
                    statusBar.classList.remove('visible');
                    return;
                }
                let stepIndex = 0;
                statusBar.classList.add('visible');
                const cycleStatus = () => {
                    statusMessage.innerHTML = STATUS_STEPS[stepIndex];
                    stepIndex = (stepIndex + 1) % STATUS_STEPS.length;
                    // Freeze on the main generation step (67%) for longer
                    if (stepIndex === 6) stepIndex = 5; 
                };
                cycleStatus();
                statusInterval = setInterval(cycleStatus, 3000);
            }

            // Function to select N random, unique elements from an array
            function getRandomUnique(arr, num) {
                const shuffled = [...arr].sort(() => 0.5 - Math.random());
                return shuffled.slice(0, num);
            }

            // Function to handle form submission
            form.addEventListener('submit', handleFormSubmit);

            // Function to update the image preview boxes
            function updateImagePreviews(urls) {
                const boxes = imagesPreviewSection.querySelectorAll('.image-box');
                boxes.forEach((box, index) => {
                    const url = urls[index];
                    if (url) {
                        box.innerHTML = `<img src="${url}" alt="Source Image ${index + 1}">`;
                    } else {
                        box.innerHTML = `<div class="image-box-placeholder">No image selected</div>`;
                    }
                });
            }

            // Function to run on initial load to show the images that will be used
            function setupInitialImages() {
                const randomUrls = getRandomUnique(POTENTIAL_IMAGE_URLS, 3);
                updateImagePreviews(randomUrls);
                form.setAttribute('data-urls', JSON.stringify(randomUrls));
            }
            
            // Run on load
            setupInitialImages();


            async function handleFormSubmit(event) {
                event.preventDefault();

                // 1. Get the 3 image URLs from the pre-set data attribute
                const randomUrls = JSON.parse(form.getAttribute('data-urls'));

                if (randomUrls.length < 3) {
                    alert('Error: Could not select 3 unique image URLs.');
                    return;
                }

                // 2. Update UI state
                generateButton.disabled = true;
                generateButton.textContent = "Cooking...";
                updateStatus(true);
                generatedImage.style.display = 'none';
                placeholderText.innerHTML = "Chef Tony is cooking. It'd show up here once he's done.";
                placeholderText.style.display = 'block';

                try {
                    // 3. Prepare JSON Payload (Crucial change: sending JSON, not FormData)
                    const payload = {
                        image_urls: randomUrls,
                        style_prompt: NEW_YORKER_STYLE_PROMPT
                    };

                    // 4. Send request with JSON body
                    const response = await fetch(N8N_WEBHOOK_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json' // Tell the server we are sending JSON
                        },
                        body: JSON.stringify(payload), // Send the JSON object
                    });

                    // 5. Check for HTTP errors
                    if (!response.ok) {
                        let errorDetail = response.statusText;
                        try {
                            const errorBody = await response.text();
                            errorDetail = errorBody || response.statusText;
                        } catch (e) { /* Ignore */ }
                        
                        throw new Error(`HTTP Error! Status: ${response.status}. Detail: ${errorDetail.substring(0, 100)}...`);
                    }
                    
                    // 6. Handle successful response (EXPECTING RAW BINARY/BLOB DATA)
                    const imageBlob = await response.blob();
                    const imageUrl = URL.createObjectURL(imageBlob);

                    generatedImage.src = imageUrl;
                    generatedImage.style.display = 'block';
                    placeholderText.style.display = 'none';

                } catch (error) {
                    console.error('Generation failed:', error);
                    alert(`Comic generation failed. Error: ${error.message}`);
                    placeholderText.innerHTML = `Generation Failed: ${error.message}. Please try again.`;
                    placeholderText.style.display = 'block';
                    generatedImage.style.display = 'none';
                } finally {
                    // 7. Reset state and setup for the next run
                    generateButton.disabled = false;
                    generateButton.textContent = "Cook New Daily Comic Now!";
                    updateStatus(false);
                    // Select new random images for the next submission
                    setupInitialImages(); 
                }
            }
        });
    </script>
</body>
</html>
