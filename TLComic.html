<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link href="https://fonts.googleapis.com/css2?family=Amatic+SC:wght@400;700&family=Handlee&display=swap" rel="stylesheet">
    <title>The Lined Comic - New Yorker Daily Comic Generator</title>
    <style>
        /* General Styling */
        body {
            font-family: 'Handlee', cursive;
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            line-height: 1.25;
        }

        /* Container for the App */
        .generator-container {
            background-color: #fff;
            padding: 40px;
            border-radius: 12px;
            max-width: 900px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 30px;
            position: relative;
            box-sizing: border-box;
        }

        /* ------------------------------------------- */
        /* HEADER SECTION */
        /* ------------------------------------------- */
        .header-section {
            margin: -40px -40px 30px -40px;
            padding: 40px 40px 20px 40px;
            background-image: url('https://raw.githubusercontent.com/masoudassali/TLC/refs/heads/main/Header.jpg');
            background-size: cover;
            background-position: 50% 35%;
            background-repeat: no-repeat;
            height: 180px;
            position: relative; 
            border-radius: 12px 12px 0 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
        }

        .header-text-highlight {
            background-color: rgba(240, 240, 240, 0.95);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 5px 10px;
            line-height: 1;
            box-decoration-break: clone;
            display: inline-block;
        }

        .logo-container {
            position: absolute;
            top: 30px;
            right: 30px;
            z-index: 10;
        }

        .logo-container img {
            width: 80px;
            height: auto;
            filter: none;
            display: block;
        }

        .header-section h1 {
            font-family: 'Amatic SC', cursive;
            color: #222;
            text-align: center;
            margin-top: 5px;
            margin-bottom: 0;
            font-weight: 700;
            font-size: 3.8em;
            padding-right: 0;
            padding-left: 0;
            line-height: 1.2;
            text-shadow: none;
        }

        .header-section .subtitle {
            color: #444;
            text-align: center;
            margin-top: 5px;
            margin-bottom: 0;
            font-style: normal;
            font-size: 2.2em;
            line-height: 1.2;
            padding-right: 0;
            padding-left: 0;
            text-shadow: none;
        }
        /* ------------------------------------------- */
        /* END HEADER SECTION STYLES */
        /* ------------------------------------------- */

        /* Simplified Form Styling */
        .prompt-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
            box-sizing: border-box;
        }

        .prompt-form label {
            font-size: 1.5em;
            color: #5D4037;
            margin: 0;
            line-height: 1.1;
        }

        /* --- Collapsible Info Section --- */
        .info-container {
            padding: 15px 20px;
            background-color: #fff9f5;
            border: 2px solid #E64A19;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
        }
        .info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .info-header h3 {
            font-size: 2em;
            color: #E64A19;
            margin: 0;
        }
        .info-content p {
            font-size: 1.3em;
            color: #5D4037;
            margin: 5px 0;
            text-align: left;
        }
        
        /* --- Image Upload & Preview Section --- */
        .image-upload-wrapper {
            display: flex;
            justify-content: space-around;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .upload-slot {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        /* New class for the clickable preview box */
        .image-preview-box {
            width: 150px;
            height: 150px;
            border: 2px dashed #BDBDBD;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #fff;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .image-preview-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        
        .image-preview-box span {
            font-size: 0.9em;
            color: #9E9E9E;
            text-align: center;
            padding: 10px;
            display: block;
        }

        .upload-slot input[type="file"] {
            display: none; /* Hide the default file input */
        }
        
        /* FIX: Styled Upload Label */
        .upload-label {
            /* Matched to the main button style for continuity */
            background-color: #FF7043; 
            color: white;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
            font-family: 'Handlee', cursive;
            line-height: 1;
        }

        .upload-label:hover {
            background-color: #E64A19;
        }
        /* ----------------------------------- */


        button {
            /* General button styling for generate and toggle buttons */
            background-color: #FF7043;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.8em;
            font-weight: bold;
            transition: background-color 0.3s;
            font-family: 'Handlee', cursive;
            line-height: 1;
            margin-top: 0;
        }
        
        /* Override for the smaller toggle button */
        #toggleInfoButton {
            padding: 8px 12px;
            font-size: 1.1em;
            font-weight: normal;
            min-width: 70px;
            box-sizing: border-box;
            border-radius: 6px;
        }

        button:hover {
            background-color: #E64A19;
        }

        /* Centering the generate button */
        .submit-button-wrapper {
            margin-top: 20px;
            text-align: center;
        }
        
        /* Chef Tony Info Section (Kept for branding) */
        .chef-tony-info {
            padding: 10px 0;
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .chef-tony-info p {
            font-size: 1.3em;
            color: #5D4037;
            font-weight: bold;
            margin-top: 0;
            margin-bottom: 10px;
        }
        .chef-tony-images {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .chef-tony-images img {
            width: 120px;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border: 2px solid #FF7043;
        }

        /* Status Bar Styling */
        .status-bar {
            text-align: center;
            min-height: 20px;
            margin-top: -15px;
            color: #FF7043;
            font-size: 1.5em;
            font-weight: 700;
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            font-family: 'Handlee', cursive;
            line-height: 1;
        }

        .status-bar.visible {
            opacity: 1;
        }
        
        /* Class for hiding content */
        .content-hidden {
            display: none;
        }

        /* Image Display Area */
        .image-display {
            border: 2px dashed #BDBDBD;
            border-radius: 8px;
            min-height: 350px;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            background-color: #FAFAFA;
            box-sizing: border-box;
        }

        .image-placeholder {
            color: #9E9E9E;
            font-style: italic;
            font-size: 1.5em;
            font-family: 'Handlee', cursive;
            line-height: 1.25;
        }

        .generated-image {
            max-width: 100%;
            max-height: 350px;
            border-radius: 6px;
            display: none;
        }

        /* Responsive tweaks */
        @media (max-width: 600px) {
            .header-section h1 { font-size: 2.8em; padding-right: 0; margin-top: 5px; }
            .header-section .subtitle { font-size: 1.6em; padding-right: 0; } 
            
            .image-upload-wrapper {
                flex-direction: column;
                align-items: center;
            }
            .upload-slot {
                width: 100%;
                max-width: 250px;
            }
        }

        /* Logo above title for small screens (5in = 480px) */
        @media (max-width: 5in) {
            .generator-container { padding: 20px; gap: 20px; }
            .header-section {
                height: auto;
                padding: 20px 20px 5px 20px;
                margin: -20px -20px 20px -20px;
            }
            .logo-container {
                position: static;
                margin: 0px auto 10px auto;
                right: auto;
                top: auto;
            }
            .header-section h1 {
                margin-top: 0;
            }
            .chef-tony-images {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="generator-container">
        <div class="header-section">
            <div class="logo-container">
                <img src="https://raw.githubusercontent.com/masoudassali/TLC/refs/heads/main/TLC%20Logo.png" alt="The Lined Canvas Logo">
            </div>
            <h1>
                <span class="header-text-highlight">The Lined Comic</span>
            </h1>
            <p class="subtitle">
                <span class="header-text-highlight">Chef Tony cooks up a daily comic!</span>
            </p>
        </div>
        
        <div class="info-container">
            <div class="info-header">
                <h3>How it works...</h3>
                <button id="toggleInfoButton" type="button">Show</button>
            </div>
            <div id="infoContent" class="content-hidden info-content">
                <p>Chef Tony takes **3 of your images**, analyzes their themes and content, and combines them into a single, cohesive comic panel in the style of **The New Yorker's Daily Cartoon**.</p>
                
                <div class="chef-tony-info" style="border-top: 1px dashed #E64A19; padding-top: 15px; margin-top: 15px;">
                    <p>Who is Chef Tony?</p>
                    <ol style="margin-top: 0; padding-left: 20px; text-align: left; font-size: 1em;">
                        <li>Chef Tony is our chubbily cute and friendly "AI Chef" who cooks up creative outlines.</li>
                    </ol>
                    <div class="chef-tony-images">
                        <img src="https://raw.githubusercontent.com/masoudassali/TLC/main/Chef_Tony_3D.png" alt="Chef Tony 3D Illustration">
                        <img src="https://raw.githubusercontent.com/masoudassali/TLC/main/Chef_Tony_Flatt.png" alt="Chef Tony Flat Illustration">
                    </div>
                </div>
            </div>
        </div>

        <form class="prompt-form" id="imageGenerationForm">
            
            <label style="font-size: 1.5em; text-align: center;">Upload the 3 images for Chef Tony to analyze:</label>
            <div class="image-upload-wrapper">
                
                <div class="upload-slot">
                    <label for="imageUpload1" class="image-preview-box">
                        <img id="imagePreview1" src="" alt="Image 1 Preview" style="display:none;">
                        <span id="previewText1">Image 1</span>
                    </label>
                    <input type="file" id="imageUpload1" name="image1" accept="image/png, image/jpeg, image/tiff" required>
                    <label for="imageUpload1" class="upload-label">Upload Image 1</label>
                </div>

                <div class="upload-slot">
                    <label for="imageUpload2" class="image-preview-box">
                        <img id="imagePreview2" src="" alt="Image 2 Preview" style="display:none;">
                        <span id="previewText2">Image 2</span>
                    </label>
                    <input type="file" id="imageUpload2" name="image2" accept="image/png, image/jpeg, image/tiff" required>
                    <label for="imageUpload2" class="upload-label">Upload Image 2</label>
                </div>

                <div class="upload-slot">
                    <label for="imageUpload3" class="image-preview-box">
                        <img id="imagePreview3" src="" alt="Image 3 Preview" style="display:none;">
                        <span id="previewText3">Image 3</span>
                    </label>
                    <input type="file" id="imageUpload3" name="image3" accept="image/png, image/jpeg, image/tiff" required>
                    <label for="imageUpload3" class="upload-label">Upload Image 3</label>
                </div>

            </div>

            <div class="submit-button-wrapper">
                <button type="submit" id="generateButton">Cook New Daily Comic Now!</button>
                <p style="font-size: 0.8em; color: #757575; margin-top: 5px;">
                    Please upload all three images before submitting. Max 7MB per file.
                </p>
            </div>
        </form>

        <hr style="border: 0; height: 1px; background-image: linear-gradient(to right, rgba(0, 0, 0, 0), #FF7043, rgba(0, 0, 0, 0));">
        <div class="status-bar" id="statusBar">
            <span id="statusMessage"></span>
        </div>
        <h2>Your Generated Comic Preview</h2>
        <div class="image-display">
            <p class="image-placeholder" id="placeholderText">Chef Tony is cooking. It'd show up here once he's done.</p>
            <img src="" alt="AI Generated Comic" class="generated-image" id="generatedImage">
        </div>
    </div>
    <script>
        // *** CORE CONFIG & DOM ELEMENTS ***
        const N8N_WEBHOOK_URL = 'https://steak.servequake.com/webhook-test/90ddc1c7-3ae3-46ff-919b-a923d1473dd3'; 
        const MAX_FILE_SIZE_BYTES = 7 * 1024 * 1024; // 7MB
        
        // Fixed style for the new project
        const NEW_YORKER_STYLE_PROMPT = "The final output must be a single, simple, black and white comic panel in the style of The New Yorker's Daily Cartoon. Analyze the three provided images for their main subject, theme, or concept, and combine these elements into a single, slightly humorous or ironic scene. Focus on clear outlines and minimal detail to capture the iconic New Yorker aesthetic.";
        
        // Wrap initialization so it runs after DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('imageGenerationForm');
            const placeholderText = document.getElementById('placeholderText');
            const generatedImage = document.getElementById('generatedImage');
            const generateButton = document.getElementById('generateButton');
            const statusBar = document.getElementById('statusBar');
            const statusMessage = document.getElementById('statusMessage');

            // FIX: Get the new collapsible elements
            const infoContent = document.getElementById('infoContent');
            const toggleInfoButton = document.getElementById('toggleInfoButton');

            // Arrays to manage inputs and previews
            const imageUploads = [
                document.getElementById('imageUpload1'),
                document.getElementById('imageUpload2'),
                document.getElementById('imageUpload3'),
            ];
            const imagePreviews = [
                document.getElementById('imagePreview1'),
                document.getElementById('imagePreview2'),
                document.getElementById('imagePreview3'),
            ];
            const previewTexts = [
                document.getElementById('previewText1'),
                document.getElementById('previewText2'),
                document.getElementById('previewText3'),
            ];
            
            // Status Bar Steps (Adjusted for the new workflow)
            const STATUS_STEPS = [
                "5% - Uploading 3 images to the server...",
                "18% - Chef Tony is analyzing the content of the three images...",
                "35% - Combining concepts for a single comic scene...",
                "50% - Sketching the New Yorker style panel...",
                "67% - This may take 5-15 seconds...",
                "93% - Sending image data back to your browser...",
                "100% - Serving up your daily comic now..."
            ];

            // Status Bar Control
            let statusInterval;

            function updateStatus(start) {
                if (!start) {
                    clearInterval(statusInterval);
                    statusBar.classList.remove('visible');
                    return;
                }
                let stepIndex = 0;
                statusBar.classList.add('visible');
                const cycleStatus = () => {
                    statusMessage.innerHTML = STATUS_STEPS[stepIndex];
                    stepIndex = (stepIndex + 1) % STATUS_STEPS.length;
                    // Freeze on the main generation step (67%) for longer
                    if (stepIndex === 6) stepIndex = 5; 
                };
                cycleStatus();
                statusInterval = setInterval(cycleStatus, 3000);
            }

            // Image Preview Handler
            imageUploads.forEach((upload, index) => {
                upload.addEventListener('change', function() {
                    const file = this.files[0];
                    const previewImg = imagePreviews[index];
                    const previewText = previewTexts[index];

                    if (file) {
                        if (file.size > MAX_FILE_SIZE_BYTES) {
                            alert(`File size exceeds the limit of ${MAX_FILE_SIZE_BYTES / (1024 * 1024)}MB. Please choose a smaller file.`);
                            this.value = ''; // Clear the file input
                            previewImg.style.display = 'none';
                            previewText.style.display = 'block';
                            return;
                        }

                        const reader = new FileReader();
                        reader.onload = function(e) {
                            previewImg.src = e.target.result;
                            previewImg.style.display = 'block'; // Show the image
                            previewText.style.display = 'none'; // Hide the text
                        };
                        reader.readAsDataURL(file);
                    } else {
                        previewImg.src = '';
                        previewImg.style.display = 'none'; // Hide the image
                        previewText.style.display = 'block'; // Show the text
                    }
                });
            });

            // FIX: Toggle logic for the How it Works section
            toggleInfoButton.addEventListener('click', () => {
                const isHidden = infoContent.classList.toggle('content-hidden');
                toggleInfoButton.textContent = isHidden ? 'Show' : 'Hide';
            });

            // Function to handle form submission
            form.addEventListener('submit', handleFormSubmit);

            async function handleFormSubmit(event) {
                event.preventDefault();

                // 1. Check if all three images are uploaded
                const files = [
                    imageUploads[0].files[0],
                    imageUploads[1].files[0],
                    imageUploads[2].files[0],
                ];

                if (files.some(file => !file)) {
                    alert('Please upload all three images before submitting.');
                    return;
                }
                
                // Check file sizes
                if (files.some(file => file.size > MAX_FILE_SIZE_BYTES)) {
                    alert(`One or more files exceed the limit of ${MAX_FILE_SIZE_BYTES / (1024 * 1024)}MB. Please choose smaller files.`);
                    return;
                }

                // 2. Update UI state
                generateButton.disabled = true;
                generateButton.textContent = "Cooking...";
                updateStatus(true);
                generatedImage.style.display = 'none';
                placeholderText.innerHTML = "Chef Tony is cooking. It'd show up here once he's done.";
                placeholderText.style.display = 'block';

                try {
                    // 3. Prepare FormData (Crucial change: sending files using FormData)
                    const formData = new FormData();
                    formData.append('prompt', NEW_YORKER_STYLE_PROMPT); // The prompt for the Gemini model
                    formData.append('image1', files[0]);
                    formData.append('image2', files[1]);
                    formData.append('image3', files[2]);


                    // 4. Send request with FormData body
                    const response = await fetch(N8N_WEBHOOK_URL, {
                        method: 'POST',
                        // Do NOT set Content-Type header manually for FormData.
                        // The browser sets it automatically, including the necessary boundary=...
                        body: formData, 
                    });

                    // 5. Check for HTTP errors
                    if (!response.ok) {
                        let errorDetail = response.statusText;
                        try {
                            const errorBody = await response.text();
                            errorDetail = errorBody || response.statusText;
                        } catch (e) { /* Ignore */ }
                        
                        throw new Error(`HTTP Error! Status: ${response.status}. Detail: ${errorDetail.substring(0, 100)}...`);
                    }
                    
                    // 6. Handle successful response (EXPECTING RAW BINARY/BLOB DATA)
                    const imageBlob = await response.blob();
                    const imageUrl = URL.createObjectURL(imageBlob);

                    generatedImage.src = imageUrl;
                    generatedImage.style.display = 'block';
                    placeholderText.style.display = 'none';

                } catch (error) {
                    console.error('Generation failed:', error);
                    alert(`Comic generation failed. Error: ${error.message}`);
                    placeholderText.innerHTML = `Generation Failed: ${error.message}. Please try again.`;
                    placeholderText.style.display = 'block';
                    generatedImage.style.display = 'none';
                } finally {
                    // 7. Reset state
                    generateButton.disabled = false;
                    generateButton.textContent = "Cook New Daily Comic Now!";
                    updateStatus(false);
                }
            }
        });
    </script>
</body>
</html>
