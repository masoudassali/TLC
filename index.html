<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link href="https://fonts.googleapis.com/css2?family=Amatic+SC:wght@400;700&family=Handlee&display=swap" rel="stylesheet">
    <title>The Lined Canvas - Generate Your Masterpiece Outline</title>
    <style>
        /* General Styling */
        body {
            font-family: 'Handlee', cursive; /* non-title font */
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            line-height: 1.25;
        }

        /* Container for the App */
        .generator-container {
            background-color: #fff;
            padding: 40px;
            border-radius: 12px;
            max-width: 900px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 30px;
            position: relative;
            box-sizing: border-box;
        }

        /* ------------------------------------------- */
        /* HEADER SECTION WITH BACKGROUND IMAGE */
        /* ------------------------------------------- */
        .header-section {
            /* Use negative margins to pull the header out to the edges of the container padding (40px) */
            margin: -40px -40px 30px -40px;
            /* Re-apply internal padding, reduce bottom padding to pull content closer */
            padding: 40px 40px 20px 40px;

            /* Background Image Setup */
            background-image: url('https://raw.githubusercontent.com/masoudassali/TLC/refs/heads/main/Header.jpg');
            background-size: cover;
            background-position: 50% 35%; 
            background-repeat: no-repeat;
            
            height: 180px; 
            
            position: relative; 
            border-radius: 12px 12px 0 0; 
            overflow: hidden; 
            
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            /* UPDATED: Center the text horizontally */
            align-items: center; 
        }

        /* Styling for the new wrapper spans */
        .header-text-highlight {
            /* UPDATED: Light Gray background */
            background-color: rgba(240, 240, 240, 0.95); 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Subtle lift */
            padding: 5px 10px;
            line-height: 1; /* Reset line-height inherited from block element */
            box-decoration-break: clone; /* Allows padding/bg to wrap multi-line text cleanly */
            display: inline-block; /* Essential for padding/bg to wrap text */
        }

        /* Logo Styling */
        .logo-container {
            position: absolute;
            top: 30px;
            right: 30px;
            z-index: 10;
        }

        .logo-container img {
            width: 80px;
            height: auto;
            filter: none;
            display: block;
        }

        /* Header Title Styling */
        .header-section h1 {
            font-family: 'Amatic SC', cursive;
            color: #222; 
            /* UPDATED: Center text within its container */
            text-align: center;
            margin-top: 5px; 
            margin-bottom: 0;
            font-weight: 700;
            font-size: 3.8em;
            padding-right: 0; /* Removed padding to allow centering */
            padding-left: 0; /* Removed padding to allow centering */
            line-height: 1.2; 
            text-shadow: none; 
        }

        .header-section .subtitle {
            color: #444; 
            /* UPDATED: Center text within its container */
            text-align: center;
            margin-top: 5px; 
            margin-bottom: 0;
            font-style: normal;
            font-size: 2.2em;
            line-height: 1.2;
            padding-right: 0; /* Removed padding to allow centering */
            padding-left: 0; /* Removed padding to allow centering */
            text-shadow: none; 
        }
        /* ------------------------------------------- */
        /* END HEADER SECTION STYLES */
        /* ------------------------------------------- */


        /* Prompt Form Styling */
        .prompt-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
            box-sizing: border-box;
        }

        .prompt-form label {
            font-size: 1.5em;
            color: #5D4037;
            margin: 0;
            line-height: 1.1;
        }

        textarea {
            width: 100%;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1.5em;
            resize: vertical;
            min-height: 100px;
            box-sizing: border-box;
            transition: border-color 0.3s;
            font-family: 'Handlee', cursive;
            line-height: 1.25;
        }

        /* Placeholder styles (carried over from previous request) */
        textarea::placeholder {
            font-size: 1.0em; /* Reduced size */
            color: #9e9e9e;
            opacity: 1;
        }

        textarea:focus {
            border-color: #FF7043;
            outline: none;
            box-shadow: 0 0 0 2px rgba(255, 112, 67, 0.5);
        }

        button {
            background-color: #FF7043;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.8em;
            font-weight: bold;
            transition: background-color 0.3s;
            font-family: 'Handlee', cursive;
            line-height: 1;
        }

        button:hover {
            background-color: #E64A19;
        }

        /* Preset Options Styling */
        .preset-options {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
            box-sizing: border-box;
            overflow: visible;
        }

        /* Container for the Heading and Button */
        .preset-header {
            display: flex;
            align-items: center;
            border-bottom: 1px solid #eee;
            margin-bottom: 12px;
            padding-bottom: 5px;
        }

        .preset-options h3 {
            font-size: 2em;
            color: #FF7043;
            margin: 0;
            margin-right: 15px; 
            line-height: 1;
            font-family: 'Handlee', cursive;
        }
        
        /* New button style for the main toggle */
        .main-toggle-button {
            margin-left: auto;
            background: #FF7043;
            border: none;
            color: white;
            font-size: 1.2em;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 4px;
            text-align: center;
            line-height: 1;
            transition: background-color 0.2s;
            font-family: 'Handlee', cursive;
            flex-shrink: 0; 
        }

        .main-toggle-button:hover {
            background: #E64A19;
        }

        .preset-category {
            margin-bottom: 15px;
        }

        .preset-category h4 {
            font-size: 1.5em;
            color: #5D4037;
            margin: 5px 0;
            text-decoration: underline;
            line-height: 1.05;
            font-family: 'Handlee', cursive;
        }

        .preset-category label {
            display: inline-block;
            margin-right: 15px;
            cursor: pointer;
            font-size: 1.2em;
            line-height: 1.5;
            vertical-align: middle;
            font-family: 'Handlee', cursive;
        }

        /* Busyness Gauge Styling */
        .busyness-gauge {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px 0;
            border-top: 1px solid #eee;
            margin-top: 15px;
            flex-wrap: wrap;
            box-sizing: border-box;
        }
        
        /* Busyness radio buttons now arranged vertically for clarity */
        .busyness-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .busyness-gauge h4 {
            margin: 0;
            min-width: 100px;
            font-size: 1.5em;
            line-height: 1;
            font-family: 'Handlee', cursive;
            align-self: flex-start; /* Align title to the top */
            padding-top: 5px; /* Visual spacing */
        }

        .busyness-gauge label {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 1.2em;
            line-height: 1.2;
            font-family: 'Handlee', cursive;
        }

        .busyness-gauge input[type="radio"] {
            transform: translateY(0);
        }

        /* Status Bar Styling */
        .status-bar {
            text-align: center;
            min-height: 20px;
            margin-top: -15px;
            color: #FF7043;
            font-size: 1.5em;
            font-weight: 700;
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            font-family: 'Handlee', cursive;
            line-height: 1;
        }

        .status-bar.visible {
            opacity: 1;
        }

        /* Image Display Area */
        .image-display {
            border: 2px dashed #BDBDBD;
            border-radius: 8px;
            min-height: 350px;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            background-color: #FAFAFA;
            box-sizing: border-box;
        }

        .image-placeholder {
            color: #9E9E9E;
            font-style: italic;
            font-size: 1.5em;
            font-family: 'Handlee', cursive;
            line-height: 1.25;
        }

        .generated-image {
            max-width: 100%;
            max-height: 350px;
            border-radius: 6px;
            display: none;
        }

        /* Styles for hidden content */
        .hidden-content {
            display: none;
        }

        /* Responsive tweaks */
        @media (max-width: 600px) {
            .header-section h1 { font-size: 2.8em; padding-right: 0; margin-top: 5px; }
            .header-section .subtitle { font-size: 1.8em; padding-right: 0; }
            .preset-options h3 { font-size: 1.6em; }
            .busyness-gauge h4 { min-width: 120px; font-size: 1.2em; }
            .preset-category label, .busyness-gauge label { font-size: 1.05em; }
            textarea { font-size: 1.15em; }
            textarea::placeholder { font-size: 0.9em; } 
        }
    </style>
</head>
<body>

    <div class="generator-container">
        
        <div class="header-section">
            <div class="logo-container">
                <img src="https://raw.githubusercontent.com/masoudassali/TLC/refs/heads/main/TLC%20Logo.png" alt="The Lined Canvas Logo">
            </div>
            <h1>
                <span class="header-text-highlight">The Lined Canvas</span>
            </h1>
            <p class="subtitle">
                <span class="header-text-highlight">Let Tony cook you the outline for your next masterpiece, and he'll ship it to your door too.</span>
            </p>
        </div>
        <form class="prompt-form" id="imageGenerationForm">
            <label for="prompt" style="font-size: 1.5em;">Describe in detail what outline you'd like to get for your next masterpiece. <i>Or select below.</i></label>
            <textarea id="prompt" name="prompt" placeholder="Start typing your description... Example: A whimsical kitten. Detailed fur. Playful pose lines, geometric tiles, medium-sized tiles." required></textarea>
            <button type="submit">Ok Tony, cook me an amazing outline...</button>
        </form>

        <div class="preset-options">
            <div class="preset-header">
                <h3>Artist's Block?</h3>
                <button type="button" class="main-toggle-button" id="mainToggleButton">
                    Try these ideas...
                </button>
            </div>
            
            <div id="allPresetsWrapper" class="hidden-content"> 

                <div id="presetsContainer">
                    </div>

                <div class="busyness-gauge">
                    <h4>Page Busyness</h4>
                    <div class="busyness-options">
                        <label>
                            <input type="radio" name="busyness" value="simple, minimal geometric tiles, few large tiles, 70% of the page is empty">
                            <span>Minimally Busy</span>
                            <span style="font-size: 0.9em; color: #9E9E9E;">(Few large tiles, 70% empty)</span>
                        </label>
                        <label>
                            <input type="radio" name="busyness" value="geometric tiles, medium-sized tiles, 55% of the page is empty">
                            <span>Moderately Busy</span>
                            <span style="font-size: 0.9em; color: #9E9E9E;">(Medium tiles, 55% empty)</span>
                        </label>
                        <label>
                            <input type="radio" name="busyness" value="dense, intricate, numerous small geometric tiles, 40% of the page is empty">
                            <span>Super Busy</span>
                            <span style="font-size: 0.9em; color: #9E9E9E;">(Numerous small tiles, 40% empty)</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <hr style="border: 0; height: 1px; background-image: linear-gradient(to right, rgba(0, 0, 0, 0), #FF7043, rgba(0, 0, 0, 0));">

        <div class="status-bar" id="statusBar">
            <span id="statusMessage"></span>
        </div>

        <h2>Your Generated Outline Preview</h2>

        <div class="image-display">
            <p class="image-placeholder" id="placeholderText">Tony is cooking. It'd show up here once he's done.</p>
            <img src="" alt="AI Generated Outline" class="generated-image" id="generatedImage">
        </div>
    </div>

    <script>
        // *** PRESET DATA ***
        const PRESET_CATEGORIES = {
            "Art Style": [
                { display: "Impressionism", value: "broad, visible short brushstrokes, light focused, loose forms, en plein air and outdoors to capture the fleeting effects of natural light, depicting everyday subjects and scenes of modern life, a sense of spontaneity, an emphasis on capturing a momentary impressions, and open compositions with unusual visual angles." },
                { display: "Abstract Art", value: "non-representational forms, geometric and organic shapes, non-representational nature, emphasis on visual elements like shape and form and line, focus on emotion and concepts over realistic depiction, use visual language instead of showing recognizable objects to evoke feelings and ideas and spiritual themes, subjective interpretation." },
                { display: "Surrealism", value: "dreamlike imagery, illogical irrational juxtaposition, unexpected elements, use of techniques like automatism to tap into the subconscious, combining unrelated objects in surprising ways, depicting strange or impossible scenes, employing symbolism to explore the human psyche, rejecting rationality and order in favor of the unpredictable nature of the mind." },
                { display: "Pop Art", value: "bold, graphic, thick black outlines, commercial imagery, mass consumerism and everyday life, celebrity culture, irony and satire, hard-edged composition, typography, postmodernism." }
            ],
            "Themes": { 
                "Cities": [
                    { display: "New York City", value: "a New York City cityscape with famous landmarks, towering skyscrapers, detailed traffic" },
                    { display: "San Francisco", value: "a dense, hilly San Francisco city and landmarks with Victorian houses and the Golden Gate Bridge" },
                    { display: "Rio de Janeiro", value: "Rio de Janeiro's lush mountains, beaches, and the Christ the Redeemer statue" },
                    { display: "Istanbul", value: "Istanbul's historic mosques and markets, complex patterns, bustling waterfront" },
                    { display: "Hong Kong", value: "Hong Kong's vertical architecture, harbor view, illuminated city grid" },
                    { display: "Mecca", value: "Mecca's highly detailed Islamic architecture, complex geometric patterns, focus on the Kaaba" },
                    { display: "Dubai", value: "Dubai's futuristic architecture, tall glass buildings, sharp geometric design" },
                    { display: "Macau", value: "Macau's blend of Portuguese and modern Chinese architecture, casino lights, detailed paving" },
                    { display: "Tehran", value: "Tehran's landmarks, choose between the Azadi Tower or the Milad Tower, and urban sprawl, distant mountains, intricate Persian tile work" },
                    { display: "London", value: "London's historic architecture, Big Ben, red phone booths, detailed brickwork" },
                    { display: "Paris", value: "Paris's Eiffel Tower, ornate Haussmann buildings, Seine River view, detailed ironwork" },
                    { display: "Kuala Lumpur", value: "Kuala Lumpur's Petronas Twin Towers, lush tropical setting, detailed city foliage" },
                    { display: "Bangkok", value: "Bangkok's detailed temples, winding canals, busy street scenes, complex rooftop lines" },
                    { display: "Sydney", value: "Sydney's Opera House, harbor views, intricate yacht rigging" },
                    { display: "Tokyo", value: "neon signs, dense pedestrian streets, futuristic buildings, busy intersections" },
                    { display: "Beijing", value: "Beijing's landmarks and the Great Wall of China, urban streets, historic buildings, and Chinese architecture" }
                ],
                "Animals": [
                    { display: "Bunny", value: "a cute bunny in a whimsical field, intricate fur and whisker detail" },
                    { display: "Fox", value: "a clever fox in a forest, detailed brush and branch work" },
                    { display: "Panda", value: "a large panda eating bamboo, detailed leaf and fur texture" },
                    { display: "Quokka", value: "a smiling quokka, detailed island foliage" },
                    { display: "Hedgehog", value: "a tiny hedgehog, complex spine patterns, detailed ground cover" },
                    { display: "Penguin", value: "a penguin on ice, crisp black and white contrast, detailed snow texture" },
                    { display: "Sloth", value: "a slow sloth hanging from a branch, detailed vine and bark texture" },
                    { display: "Seal", value: "a sleek seal basking on rocks, wet skin texture, detailed water reflections" },
                    { display: "Puppy", value: "a playful puppy, soft fur texture, detailed toy lines" },
                    { display: "Kitten", value: "a curious kitten, detailed fur and playful pose lines" }
                ],
                "Landscapes": [
                    { display: "The Swiss Alps", value: "The Swiss Alps, sweeping mountain landscape, jagged peaks, small chalets, detailed snow texture" },
                    { display: "The Rocky Mountains", value: "The Rocky Mountains, rugged peaks, dense pine forests, detailed rock formations" },
                    { display: "The Grand Canyon", value: "The Grand Canyon, vast, layered rock formations, deep shadows, dry texture" },
                    { display: "Mount Rushmore", value: "Mount Rushmore, detailed presidential faces carved into rock, precise light and shadow" },
                    { display: "Zhangye Danxia Geopark", value: "Zhangye Danxia Geopark, striped rock mountains, sweeping geological layers" },
                    { display: "The Norwegian Fjords", value: "The Norwegian Fjords, sheer cliffs, calm dark water, small fishing villages, detailed reflections" },
                    { display: "The Grand Canal of Venice", value: "The Grand Canal of Venice, historic buildings, detailed boat lines, water reflections, complex shadows" },
                    { display: "The Redwood Forests", value: "The Redwood Forests, towering trees, sunbeams filtering through, detailed bark and canopy" },
                    { display: "The Japanese Cherry Blossoms", value: "The Japanese Cherry Blossoms, delicate floral patterns, sweeping tree branches, soft, scattered petals" },
                    { display: "The Serengeti", value: "The Serengeti, wide open savanna, scattered acacia trees, detailed grasses and animal silhouettes" },
                    { display: "The Sahara Desert", value: "The Sahara Desert, rolling sand dunes, extreme shadows, sparse dry plants, detailed sand patterns" }
                ]
            }
        };

        // *** CORE DOM ELEMENTS ***
        const N8N_WEBHOOK_URL = 'https://steak.servequake.com/webhook/74161287-0f76-4b39-b5b6-66393e16ca91';

        // Wrap initialization so it runs after DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('imageGenerationForm');
            const promptTextarea = document.getElementById('prompt');
            const placeholderText = document.getElementById('placeholderText');
            const generatedImage = document.getElementById('generatedImage');
            const submitButton = form.querySelector('button');
            const presetsContainer = document.getElementById('presetsContainer');
            const statusBar = document.getElementById('statusBar');
            const statusMessage = document.getElementById('statusMessage');
            const mainToggleButton = document.getElementById('mainToggleButton');
            const allPresetsWrapper = document.getElementById('allPresetsWrapper');

            // Status Bar Steps
            const STATUS_STEPS = [
                "5% - Sending your descriptions to our magician, Tony ...",
                "18% - Tony received your descriptions. Now figuring out the style...",
                "22% - Tony is adding the final touches...",
                "41% - This may take 5-15 seconds...",
                "67% - Converting everything into a PNG file...",
                "93% - Sending image data back to your browser...",
                "100% - Serving up your order now..."
            ];

            // Status Bar Control
            let statusInterval;
            function updateStatus(start) {
                if (!start) {
                    clearInterval(statusInterval);
                    statusBar.classList.remove('visible');
                    return;
                }

                let stepIndex = 0;
                statusBar.classList.add('visible');

                const cycleStatus = () => {
                    statusMessage.innerHTML = STATUS_STEPS[stepIndex];
                    stepIndex = (stepIndex + 1) % STATUS_STEPS.length;
                    // Freeze on the main generation step (41%) for longer
                    if (stepIndex === 4) stepIndex = 3;
                };

                cycleStatus();
                statusInterval = setInterval(cycleStatus, 3000);
            }

            // Function to render the presets dynamically
            function renderPresets() {
                let html = '';

                for (const categoryName in PRESET_CATEGORIES) {
                    const categoryData = PRESET_CATEGORIES[categoryName];
                    const radioGroupName = categoryName.replace(/\s/g, ''); 

                    html += `<div class="preset-category"><h4>${categoryName}</h4>`;

                    if (Array.isArray(categoryData)) {
                        // Simple array (Art Style)
                        categoryData.forEach(item => {
                            html += `
                                <label>
                                    <input type="radio" name="${radioGroupName}" value="${escapeHtml(item.value)}">
                                    ${escapeHtml(item.display)}
                                </label>
                            `;
                        });
                    } else if (typeof categoryData === 'object' && categoryName === 'Themes') {
                        // Complex object (Themes: Cities, Animals, Landscapes)
                        for (const subCategoryName in categoryData) {
                            const items = categoryData[subCategoryName];
                            
                            // Subcategory heading
                            html += `<p style="margin: 5px 0 3px 0; color: #FF7043; font-size: 1.1em;">— ${escapeHtml(subCategoryName)}:</p>`;

                            // Subcategory options
                            items.forEach(item => {
                                html += `
                                    <label>
                                        <input type="radio" name="${radioGroupName}" value="${escapeHtml(item.value)}">
                                        ${escapeHtml(item.display)}
                                    </label>
                                `;
                            });
                        }
                    }

                    html += `</div>`;
                }
                presetsContainer.innerHTML = html;

                // Attach event listener to all radio buttons
                document.querySelectorAll('input[type="radio"]').forEach(radio => {
                    radio.addEventListener('change', updatePromptBox);
                });
            }

            // Function to toggle the main preset wrapper
            function toggleMainPresets() {
                const isHidden = allPresetsWrapper.classList.toggle('hidden-content');
                
                if (isHidden) {
                    mainToggleButton.textContent = 'Try these ideas...';
                } else {
                    mainToggleButton.textContent = 'Hide ideas'; // New text for visible state
                }
            }

            // Escape HTML helper to avoid accidental markup injection in labels
            function escapeHtml(str) {
                return String(str)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            }

            // Function to update the prompt box based on selected radio buttons
            function updatePromptBox() {
                // Collects the 'value' of all checked radio buttons (which are the descriptive strings)
                const selectedOptions = Array.from(document.querySelectorAll('input[type="radio"]:checked'))
                                             .map(radio => radio.value);

                const newPrompt = selectedOptions.join(', ');
                promptTextarea.value = newPrompt;
            }

            // INITIALIZE UI
            renderPresets();
            // Attach toggle listener to the main button
            mainToggleButton.addEventListener('click', toggleMainPresets);
            
            // --- UPDATED INITIAL STATE LOGIC (Start Hidden and Unselected) ---
            // 1. Ensure content starts hidden
            allPresetsWrapper.classList.add('hidden-content');
            // 2. Set the button text to its 'show' state
            mainToggleButton.textContent = 'Try these ideas...';
            
            // 3. Clear all radio buttons (in case any were somehow set during rendering)
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.checked = false;
            });
            
            // 4. Ensure the prompt box starts empty after clearing selections
            promptTextarea.value = '';
            // -----------------------------------

            // Form Submission Logic (Binary File Handling)
            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const prompt = promptTextarea.value.trim();
                if (!prompt) return;

                // 1. Update UI for 'Loading' state
                submitButton.textContent = 'Generating... Please wait.';
                submitButton.disabled = true;
                placeholderText.textContent = 'Generating your unique outline...';
                placeholderText.style.display = 'block';
                generatedImage.style.display = 'none';

                // START STATUS BAR
                updateStatus(true);

                try {
                    // 2. Send prompt to n8n webhook
                    const response = await fetch(N8N_WEBHOOK_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ prompt: prompt }),
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    // Handle the incoming binary image data (PNG)
                    const imageBlob = await response.blob();

                    if (imageBlob.type && imageBlob.type.startsWith('image/')) {
                        const imageUrl = URL.createObjectURL(imageBlob);

                        // 3. Update UI with the result
                        generatedImage.src = imageUrl;
                        generatedImage.alt = prompt;

                        generatedImage.onload = () => {
                            // STOP STATUS BAR on successful load
                            updateStatus(false);
                            placeholderText.style.display = 'none';
                            generatedImage.style.display = 'block';
                            // revoke after a tick to avoid problems on some browsers
                            setTimeout(() => URL.revokeObjectURL(imageUrl), 1000);
                        };

                        generatedImage.onerror = () => {
                            // STOP STATUS BAR on error
                            updateStatus(false);
                            placeholderText.textContent = 'Error loading image data. The response might not be a valid image.';
                            generatedImage.style.display = 'none';
                        };
                    } else {
                        // STOP STATUS BAR on file type error
                        updateStatus(false);
                        const errorText = await imageBlob.text();
                        placeholderText.textContent = `Generation failed. N8N did not return a valid image file. Raw response: ${errorText.substring(0, 100)}...`;
                    }

                } catch (error) {
                    // STOP STATUS BAR on fetch error
                    updateStatus(false);
                    console.error('Generation Error:', error);
                    placeholderText.textContent = `An error occurred: ${error.message}. Please ensure your n8n workflow is active and configured to return a binary PNG file.`;
                } finally {
                    // 4. Reset button state
                    submitButton.textContent = 'Ok Tony, cook me an amazing outline...'; 
                    submitButton.disabled = false;
                }
            });
        });
    </script>

</body>
</html>
