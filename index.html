<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Amatic+SC:wght@400;700&display=swap" rel="stylesheet">
    
    <title>The Lined Canvas - Generate Your Masterpiece Outline</title>
    <style>
        /* General Styling */
        body {
            /* FONT CHANGE: Apply Amatic SC to the entire body */
            font-family: 'Amatic SC', cursive;
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        /* Container for the App */
        .generator-container {
            background-color: #fff;
            padding: 40px;
            border-radius: 12px;
            /* FLAT DESIGN: No box-shadow */
            max-width: 900px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 30px;
            position: relative; 
        }

        /* Logo Styling */
        .logo-container {
            /* POSITIONING: Absolute top-right */
            position: absolute; 
            top: 20px; 
            right: 20px; 
            z-index: 10; 
        }

        .logo-container img {
            width: 80px; 
            height: auto;
            /* FLAT DESIGN: No filter/shadow */
            filter: none; 
        }

        /* Header Styling */
        h1 {
            color: #5D4037; 
            text-align: center;
            margin-top: 0; 
            margin-bottom: 5px;
            font-weight: 700; 
            font-size: 3.5em; 
            padding-right: 100px; 
        }

        .subtitle {
            color: #795548;
            text-align: center;
            margin-bottom: 25px;
            font-style: normal;
            font-size: 2em; 
        }

        /* Preset Options Styling */
        .preset-options {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }

        .preset-options h3 {
            font-size: 2em;
            color: #FF7043;
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        .preset-category {
            margin-bottom: 15px;
        }

        .preset-category h4 {
            font-size: 1.5em;
            color: #5D4037;
            margin: 5px 0;
            text-decoration: underline;
        }

        .preset-category label {
            display: inline-block;
            margin-right: 15px;
            cursor: pointer;
            font-size: 1.2em;
            line-height: 1.5;
        }

        /* Busyness Gauge Styling */
        .busyness-gauge {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px 0;
            border-top: 1px solid #eee;
            margin-top: 15px;
        }
        
        .busyness-gauge h4 {
            margin: 0;
            min-width: 100px; 
            font-size: 1.5em;
        }

        /* Status Bar Styling */
        .status-bar {
            text-align: center;
            min-height: 20px;
            margin-top: -15px;
            color: #FF7043; 
            font-size: 1.5em;
            font-weight: 700;
            transition: opacity 0.3s ease-in-out;
            opacity: 0; /* Hidden by default */
        }

        .status-bar.visible {
            opacity: 1;
        }

        /* Form and Input Styling */
        .prompt-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .prompt-example {
            font-size: 1.2em;
            color: #795548;
            margin-bottom: 5px;
        }
        
        textarea {
            width: 100%;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1.5em; 
            resize: vertical;
            min-height: 100px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        textarea:focus {
            border-color: #FF7043; 
            outline: none;
            box-shadow: 0 0 0 2px rgba(255, 112, 67, 0.5); 
        }

        button {
            background-color: #FF7043;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.8em;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #E64A19;
        }

        /* Image Display Area */
        .image-display {
            border: 2px dashed #BDBDBD; 
            border-radius: 8px;
            min-height: 350px;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            background-color: #FAFAFA;
        }

        .image-placeholder {
            color: #9E9E9E;
            font-style: italic;
            font-size: 1.5em;
        }

        .generated-image {
            max-width: 100%;
            max-height: 350px;
            border-radius: 6px;
            display: none; 
        }
    </style>
</head>
<body>

    <div class="generator-container">
        <div class="logo-container">
            <img src="https://raw.githubusercontent.com/masoudassali/TLC/refs/heads/main/TLC%20Logo.png" alt="The Lined Canvas Logo"> 
        </div>
        
        <h1>The Lined Canvas</h1>
        <p class="subtitle">Generate the outline for your next masterpiece, and we'll ship it to your door.</p>

        <div class="preset-options">
            <h3>Choose Options</h3>
            
            <div id="presetsContainer">
                </div>

            <div class="busyness-gauge">
                <h4>Busyness Gauge</h4>
                <label>
                    <input type="radio" name="busyness" value="large, open geometric tiles" checked>
                    Minimally Busy
                </label>
                <label>
                    <input type="radio" name="busyness" value="dense, intricate, tiny geometric tiles">
                    Super Busy
                </label>
            </div>
            
            <p class="prompt-example">Example: *A whimsical cat reading a book in a cozy, sunlit cafe with a steaming mug.*</p>
        </div>

        <form class="prompt-form" id="imageGenerationForm">
            <label for="prompt" style="font-size: 1.5em;">Choose from the options or add your own descriptions here:</label>
            <textarea id="prompt" name="prompt" placeholder="Start typing your description..." required></textarea>
            <button type="submit">Generate Outline</button>
        </form>

        <hr style="border: 0; height: 1px; background-image: linear-gradient(to right, rgba(0, 0, 0, 0), #FF7043, rgba(0, 0, 0, 0));">

        <div class="status-bar" id="statusBar">
            <span id="statusMessage"></span>
        </div>

        <h2>Your Generated Outline Preview</h2>

        <div class="image-display">
            <p class="image-placeholder" id="placeholderText">Your AI-generated outline preview will appear here.</p>
            <img src="" alt="AI Generated Outline" class="generated-image" id="generatedImage">
        </div>
    </div>

    <script>
        // *** PRESET DATA ***
        const PRESET_CATEGORIES = {
            // Art Style on top, uses 'ArtStyle' as its radio group name
            "Art Style": [
                "Realism", "Impressionism", "Abstract Art", "Surrealism", "Pop Art"
            ],
            // Cities, Animals, Landscapes grouped under 'Category', all share 'Category' as the radio group name
            "Category": {
                "Cities": [
                    "New York City", "San Francisco", "Rio de Janeiro", "Istanbul", "Hong Kong", "Mecca", 
                    "Dubai", "Macau", "Tehran", "London", "Paris", "Kuala Lumpur", "Bangkok", "Sydney", "Tokyo"
                ],
                "Animals": [
                    "Bunny", "Fox", "Panda", "Quokka", "Hedgehog", "Penguin", "Sloth", "Seal", "Puppy", "Kitten"
                ],
                "Landscapes": [
                    "The Swiss Alps", "The Rocky Mountains", "The Grand Canyon", "Mount Rushmore", "Zhangye Danxia Geopark", 
                    "The Norwegian Fjords", "The Grand Canal of Venice", "The Redwood Forests", "The Japanese Cherry Blossoms", 
                    "The Serengeti", "The Sahara Desert"
                ]
            }
        };
        
        // *** CORE DOM ELEMENTS ***
        const N8N_WEBHOOK_URL = 'https://steak.servequake.com/webhook-test/74161287-0f76-4b39-b5b6-66393e16ca91';
        const form = document.getElementById('imageGenerationForm');
        const promptTextarea = document.getElementById('prompt');
        const placeholderText = document.getElementById('placeholderText');
        const generatedImage = document.getElementById('generatedImage');
        const submitButton = form.querySelector('button');
        const presetsContainer = document.getElementById('presetsContainer');
        const statusBar = document.getElementById('statusBar');
        const statusMessage = document.getElementById('statusMessage');

        // Status Bar Steps
        const STATUS_STEPS = [
            "Sending prompt to n8n Webhook...",
            "n8n received prompt. Now enforcing style constraints...",
            "Sending final prompt to AI Image Model...",
            "AI is generating the complex line art (This may take 5-15 seconds)...",
            "Converting and preparing binary PNG file...",
            "Sending image data back to your browser...",
            "Image received and loading..."
        ];

        // Status Bar Control
        let statusInterval;
        function updateStatus(start) {
            if (!start) {
                clearInterval(statusInterval);
                statusBar.classList.remove('visible');
                return;
            }

            let stepIndex = 0;
            statusBar.classList.add('visible');
            
            const cycleStatus = () => {
                statusMessage.innerHTML = STATUS_STEPS[stepIndex];
                stepIndex = (stepIndex + 1) % STATUS_STEPS.length;
                // Freeze on the main generation step for longer
                if (stepIndex === 4) stepIndex = 3; 
            };

            cycleStatus();
            statusInterval = setInterval(cycleStatus, 3000); // Cycle every 3 seconds
        }

        // Function to render the presets dynamically using RADIO BUTTONS
        function renderPresets() {
            let html = '';
            
            for (const categoryName in PRESET_CATEGORIES) {
                const categoryData = PRESET_CATEGORIES[categoryName];
                
                html += `<div class="preset-category"><h4>${categoryName}</h4>`;
                
                if (Array.isArray(categoryData)) {
                    // Handles simple array (Art Style)
                    const radioGroupName = categoryName.replace(/\s/g, ''); 
                    categoryData.forEach(option => {
                        html += `
                            <label>
                                <input type="radio" name="${radioGroupName}" value="${option}">
                                ${option}
                            </label>
                        `;
                    });
                } else if (typeof categoryData === 'object') {
                    // Handles nested object (Category: Cities, Animals, Landscapes)
                    const radioGroupName = categoryName.replace(/\s/g, ''); 
                    
                    for (const subCategoryName in categoryData) {
                        html += `
                            <p style="margin: 5px 0 3px 0; color: #FF7043; font-size: 1.1em;">— ${subCategoryName}:</p>
                        `;
                        categoryData[subCategoryName].forEach(option => {
                            // All sub-options share the same 'Category' radio group name
                            html += `
                                <label>
                                    <input type="radio" name="${radioGroupName}" value="${option}">
                                    ${option}
                                </label>
                            `;
                        });
                    }
                }
                
                html += `</div>`;
            }
            presetsContainer.innerHTML = html;

            // Attach event listener to all radio buttons
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.addEventListener('change', updatePromptBox);
            });
        }

        // Function to update the prompt box based on selected radio buttons
        function updatePromptBox() {
            // Get the value of the single selected radio button from EACH group: ArtStyle, Category, Busyness
            const selectedOptions = Array.from(document.querySelectorAll('input[type="radio"]:checked'))
                                         .map(radio => radio.value);
            
            const newPrompt = selectedOptions.join(', ');
            promptTextarea.value = newPrompt;
        }
        
        // Initial setup
        renderPresets();
        // Set default busyness state in the prompt box on load
        document.querySelector('input[name="busyness"][value="large, open geometric tiles"]').checked = true;
        updatePromptBox(); 


        // Form Submission Logic (Binary File Handling)
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const prompt = promptTextarea.value.trim();
            if (!prompt) return;

            // 1. Update UI for 'Loading' state
            submitButton.textContent = 'Generating... Please wait.';
            submitButton.disabled = true;
            placeholderText.textContent = 'Generating your unique outline...';
            placeholderText.style.display = 'block';
            generatedImage.style.display = 'none';
            
            // START STATUS BAR
            updateStatus(true); 

            try {
                // 2. Send prompt to n8n webhook
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ prompt: prompt }),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // Handle the incoming binary image data (PNG)
                const imageBlob = await response.blob(); 
                
                if (imageBlob.type && imageBlob.type.startsWith('image/')) {
                    const imageUrl = URL.createObjectURL(imageBlob); 
                    
                    // 3. Update UI with the result
                    generatedImage.src = imageUrl;
                    generatedImage.alt = prompt;
                    
                    generatedImage.onload = () => {
                        // STOP STATUS BAR on successful load
                        updateStatus(false); 
                        placeholderText.style.display = 'none';
                        generatedImage.style.display = 'block';
                        URL.revokeObjectURL(imageUrl); 
                    };

                    generatedImage.onerror = () => {
                        // STOP STATUS BAR on error
                        updateStatus(false); 
                        placeholderText.textContent = 'Error loading image data. The response might not be a valid image.';
                        generatedImage.style.display = 'none';
                    };
                } else {
                    // STOP STATUS BAR on file type error
                    updateStatus(false);
                    const errorText = await imageBlob.text(); 
                    placeholderText.textContent = `Generation failed. N8N did not return a valid image file. Raw response: ${errorText.substring(0, 100)}...`;
                }

            } catch (error) {
                // STOP STATUS BAR on fetch error
                updateStatus(false); 
                console.error('Generation Error:', error);
                placeholderText.textContent = `An error occurred: ${error.message}. Please ensure your n8n workflow is active and configured to return a binary PNG file.`;
            } finally {
                // 4. Reset button state
                submitButton.textContent = 'Generate Outline';
                submitButton.disabled = false;
            }
        });
    </script>

</body>
</html>
