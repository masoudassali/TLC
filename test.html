<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link href="https://fonts.googleapis.com/css2?family=Amatic+SC:wght@400;700&family=Handlee&display=swap" rel="stylesheet">
    <title>The Lined Canvas - Generate Your Masterpiece Outline</title>
    <style>
        /* General Styling */
        body {
            font-family: 'Handlee', cursive;
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            line-height: 1.25;
        }

        /* Container for the App */
        .generator-container {
            background-color: #fff;
            padding: 40px;
            border-radius: 12px;
            max-width: 900px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 30px;
            position: relative;
            box-sizing: border-box;
        }

        /* ------------------------------------------- */
        /* HEADER SECTION WITH BACKGROUND IMAGE */
        /* ------------------------------------------- */
        .header-section {
            /* Use negative margins to pull the header out to the edges of the container padding (40px) */
            margin: -40px -40px 30px -40px;
            /* Re-apply internal padding, reduce bottom padding to pull content closer */
            padding: 40px 40px 20px 40px;

            /* Background Image Setup */
            background-image: url('https://raw.githubusercontent.com/masoudassali/TLC/refs/heads/main/Header.jpg');
            background-size: cover;
            background-position: 50% 35%;
            background-repeat: no-repeat;
            height: 180px;
            position: relative; /* Base position for absolute logo positioning */
            border-radius: 12px 12px 0 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
        }

        /* Styling for the new wrapper spans */
        .header-text-highlight {
            background-color: rgba(240, 240, 240, 0.95);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 5px 10px;
            line-height: 1;
            box-decoration-break: clone;
            display: inline-block;
        }

        /* Logo Styling (Default: Absolute Positioning on the Right) */
        .logo-container {
            position: absolute;
            top: 30px;
            right: 30px;
            z-index: 10;
        }

        .logo-container img {
            width: 80px;
            height: auto;
            filter: none;
            display: block;
        }

        /* Header Title Styling */
        .header-section h1 {
            font-family: 'Amatic SC', cursive;
            color: #222;
            text-align: center;
            margin-top: 5px;
            margin-bottom: 0;
            font-weight: 700;
            font-size: 3.8em;
            padding-right: 0;
            padding-left: 0;
            line-height: 1.2;
            text-shadow: none;
        }

        .header-section .subtitle {
            color: #444;
            text-align: center;
            margin-top: 5px;
            margin-bottom: 0;
            font-style: normal;
            font-size: 2.2em;
            line-height: 1.2;
            padding-right: 0;
            padding-left: 0;
            text-shadow: none;
        }
        /* ------------------------------------------- */
        /* END HEADER SECTION STYLES */
        /* ------------------------------------------- */

        /* Prompt Form Styling */
        .prompt-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
            box-sizing: border-box;
        }

        .prompt-form label {
            font-size: 1.5em;
            color: #5D4037;
            margin: 0;
            line-height: 1.1;
        }

        textarea {
            width: 100%;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1.5em;
            resize: vertical;
            min-height: 100px;
            box-sizing: border-box;
            transition: border-color 0.3s;
            font-family: 'Handlee', cursive;
            line-height: 1.25;
            margin-bottom: 10px;
        }

        /* Placeholder styles */
        textarea::placeholder {
            font-size: 1.0em;
            color: #9e9e9e;
            opacity: 1;
        }

        textarea:focus {
            border-color: #FF7043;
            outline: none;
            box-shadow: 0 0 0 2px rgba(255, 112, 67, 0.5);
        }

        /* --- UPLOAD STYLES --- */
        .upload-options-wrapper {
            margin-bottom: 20px;
            border: 1px dashed #BDBDBD;
            padding: 20px;
            border-radius: 8px;
            background-color: #fffaf7;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .upload-options-wrapper h3 {
            font-size: 1.8em;
            color: #E64A19;
            margin-top: 0;
            margin-bottom: 5px;
            text-align: center;
            line-height: 1.1;
        }

        /* New style for the info text */
        .upload-info {
            display: block;
            text-align: center;
            font-size: 1em;
            color: #757575;
            margin-bottom: 15px;
            font-style: italic;
        }

        .upload-section {
            border: 1px solid #FF7043;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            max-width: 300px;
            width: 100%;
        }

        .upload-section label {
            font-size: 1.3em;
            color: #E64A19;
            font-weight: 700;
            text-align: center;
            line-height: 1.1;
            cursor: pointer;
            margin-bottom: 5px;
        }

        input[type="file"] {
            display: none;
        }

        .custom-file-upload {
            background-color: #FF7043;
            color: white;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.2em;
            transition: background-color 0.3s;
            font-family: 'Handlee', cursive;
            line-height: 1;
            display: inline-block;
        }

        .custom-file-upload:hover {
            background-color: #E64A19;
        }

        .image-upload-preview {
            width: 90px;
            height: 90px;
            max-width: 90px;
            max-height: 90px;
            overflow: hidden;
            border-radius: 4px;
            margin: 10px auto 0 auto; /* FIX: Center the preview element */
            border: 1px solid #ddd;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .image-upload-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        button {
            background-color: #FF7043;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.8em;
            font-weight: bold;
            transition: background-color 0.3s;
            font-family: 'Handlee', cursive;
            line-height: 1;
            margin-top: 0;
        }

        button:hover {
            background-color: #E64A19;
        }

        /* Centering the generate button */
        .submit-button-wrapper {
            margin-top: 20px;
            text-align: center;
        }

        /* Preset Options Styling (Style Preferences Section) */
        .preset-options {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
            box-sizing: border-box;
            overflow: visible;
        }

        /* Preset header (Style Preferences) */
        .preset-options h3 {
            font-size: 2em;
            color: #FF7043;
            margin: 0 0 15px 0;
            line-height: 1;
            font-family: 'Handlee', cursive;
            text-align: center;
        }

        .preset-category {
            margin-bottom: 20px; /* Increased separation between categories */
            padding-bottom: 10px;
            border-bottom: 1px dashed #eee; /* Added separator for clarity */
        }

        /* Remove border from the last category */
        #presetsContainer > div:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .preset-category h4 {
            font-size: 1.5em;
            color: #5D4037;
            margin: 5px 0;
            text-decoration: underline;
            line-height: 1.05;
            font-family: 'Handlee', cursive;
        }

        .preset-category label {
            display: inline-block;
            margin-right: 15px;
            margin-bottom: 8px; /* Added margin for stacking on small screens */
            cursor: pointer;
            font-size: 1.2em;
            line-height: 1.5;
            vertical-align: middle;
            font-family: 'Handlee', cursive;
            flex-wrap: wrap; /* Allows labels to wrap */
        }

        /* Busyness Gauge Styling */
        .busyness-gauge {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px 0;
            border-top: 1px solid #eee;
            margin-top: 15px;
            flex-wrap: wrap;
            box-sizing: border-box;
        }

        /* Busyness radio buttons now arranged vertically for clarity */
        .busyness-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex-grow: 1; /* Allows it to take up available horizontal space */
        }

        .busyness-gauge h4 {
            margin: 0;
            min-width: 120px; /* Set a minimum width for the header */
            font-size: 1.5em;
            line-height: 1;
            font-family: 'Handlee', cursive;
            align-self: flex-start;
            padding-top: 5px;
            text-decoration: none; /* Remove underline for this header */
            color: #5D4037; /* Consistent color */
        }

        .busyness-gauge label {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 1.2em;
            line-height: 1.2;
            font-family: 'Handlee', cursive;
            margin-right: 0;
        }

        .busyness-gauge input[type="radio"] {
            transform: translateY(0);
        }

        /* Status Bar Styling */
        .status-bar {
            text-align: center;
            min-height: 20px;
            margin-top: -15px;
            color: #FF7043;
            font-size: 1.5em;
            font-weight: 700;
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            font-family: 'Handlee', cursive;
            line-height: 1;
        }

        .status-bar.visible {
            opacity: 1;
        }

        /* Image Display Area */
        .image-display {
            border: 2px dashed #BDBDBD;
            border-radius: 8px;
            min-height: 350px;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            background-color: #FAFAFA;
            box-sizing: border-box;
        }

        .image-placeholder {
            color: #9E9E9E;
            font-style: italic;
            font-size: 1.5em;
            font-family: 'Handlee', cursive;
            line-height: 1.25;
        }

        .generated-image {
            max-width: 100%;
            max-height: 350px;
            border-radius: 6px;
            display: none;
        }

        /* Responsive tweaks */
        @media (max-width: 600px) {
            .header-section h1 { font-size: 2.8em; padding-right: 0; margin-top: 5px; }
            .header-section .subtitle { font-size: 1.8em; padding-right: 0; }
            .preset-options h3 { font-size: 1.6em; }
            .busyness-gauge h4 { min-width: 100%; text-align: center; font-size: 1.4em; } /* Full width on mobile */
            .preset-category label, .busyness-gauge label { font-size: 1.05em; }
            textarea { font-size: 1.15em; }
            textarea::placeholder { font-size: 0.9em; }

            .upload-sections-container {
                flex-direction: column;
            }

            .busyness-gauge {
                flex-direction: column; /* Stack header and options */
                align-items: stretch;
            }
            .busyness-options {
                width: 100%;
            }

            .preset-category {
                /* Ensure radio options stack nicely */
                display: flex;
                flex-direction: column;
                align-items: flex-start;
            }
            .preset-category label {
                width: 100%;
                margin-right: 0;
            }
        }

        /* ------------------------------------------- */
        /* UPDATED MEDIA QUERY: Logo above title for small screens (5in = 480px) */
        /* ------------------------------------------- */
        @media (max-width: 5in) {
            .generator-container { padding: 20px; gap: 20px; }
            /* Make sure the header height can accommodate the stacked elements */
            .header-section {
                height: auto;
                padding: 20px 20px 5px 20px;
                margin: -20px -20px 20px -20px; /* Adjust negative margins for new padding */
            }

            /* Move logo out of absolute flow and center it */
            .logo-container {
                position: static;
                margin: 0px auto 10px auto; /* 0px top margin, 10px bottom margin */
                right: auto;
                top: auto;
            }

            /* Adjust title margin since the logo is now above it */
            .header-section h1 {
                margin-top: 0;
            }
        }
    </style>
</head>
<body>
    <div class="generator-container">
        <div class="header-section">
            <div class="logo-container">
                <img src="https://raw.githubusercontent.com/masoudassali/TLC/refs/heads/main/TLC%20Logo.png" alt="The Lined Canvas Logo">
            </div>
            <h1>
                <span class="header-text-highlight">The Lined Canvas</span>
            </h1>
            <p class="subtitle">
                <span class="header-text-highlight">Let Tony cook you the outline for your next masterpiece, and he'll ship it to your door too.</span>
            </p>
        </div>
        <form class="prompt-form" id="imageGenerationForm">
            <div class="upload-options-wrapper">
                <h3>Choose your image, then describe the style you want:</h3>
                <span class="upload-info">Image types allowed: JPEG/JPG, PNG, TIFF. Image size limit: **7mbs.**</span>
                <div class="upload-section">
                    <label for="imageUpload">Upload from your device:</label>
                    <input type="file" id="imageUpload" name="image" accept=".png, .jpeg, .jpg, .tiff">
                    <div class="custom-file-upload" onclick="document.getElementById('imageUpload').click()">
                        Choose Image File
                    </div>
                </div>
                <div class="image-upload-preview" id="imagePreviewContainer">
                    <img id="imagePreview" src="https://github.com/masoudassali/TLC/blob/main/Thumbnail%20Placeholder.png?raw=true" alt="Uploaded Image Preview">
                </div>
            </div>
            <label for="prompt" style="font-size: 1.5em;">Describe any style preferences for your outline:</label>
            <textarea id="prompt" name="prompt" placeholder="Example: Use strong, thick outlines. Ignore background elements. Keep fur detail in the foreground. (Or select below.)" required></textarea>
            <div class="preset-options">
                <h3>Style Preferences</h3>
                <div id="allPresetsWrapper">
                    <div id="presetsContainer">
                    </div>
                    <div class="busyness-gauge">
                        <h4>Page Busyness</h4>
                        <div class="busyness-options">
                            <label>
                                <input type="radio" name="busyness" value="simple, minimal geometric tiles, few large tiles, 70% of the page is empty">
                                <span>Minimally Busy</span>
                                <span style="font-size: 0.9em; color: #9E9E9E;">(Few large tiles, 70% empty)</span>
                            </label>
                            <label>
                                <input type="radio" name="busyness" value="geometric tiles, medium-sized tiles, 55% of the page is empty">
                                <span>Moderately Busy</span>
                                <span style="font-size: 0.9em; color: #9E9E9E;">(Medium tiles, 55% empty)</span>
                            </label>
                            <label>
                                <input type="radio" name="busyness" value="dense, intricate, numerous small geometric tiles, 40% of the page is empty">
                                <span>Super Busy</span>
                                <span style="font-size: 0.9em; color: #9E9E9E;">(Numerous small tiles, 40% empty)</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="submit-button-wrapper">
                <button type="submit">Ok Tony, cook me an amazing outline...</button>
            </div>
        </form>
        <hr style="border: 0; height: 1px; background-image: linear-gradient(to right, rgba(0, 0, 0, 0), #FF7043, rgba(0, 0, 0, 0));">
        <div class="status-bar" id="statusBar">
            <span id="statusMessage"></span>
        </div>
        <h2>Your Generated Outline Preview</h2>
        <div class="image-display">
            <p class="image-placeholder" id="placeholderText">Tony is cooking. It'd show up here once he's done.</p>
            <img src="" alt="AI Generated Outline" class="generated-image" id="generatedImage">
        </div>
    </div>
    <script>
        // *** PRESET DATA ***
        const PRESET_CATEGORIES = {
            "Influential Artists": [
                { display: "Leonardo da Vinci", value: "In the style of Leonardo da Vinci, Utilize meticulous anatomical realism combined with subtle sfumato for softened transitions, pyramidal composition, and an emphasis on psychological depth and idealization." },
                { display: "Frida Kahlo", value: "In the style of Frida Kahlo, Employ hyper-realistic self-portraiture within a Surrealist context, integrating Mexican folk art motifs, and symbolic elements that chronicle physical and emotional suffering on a planar surface." },
                { display: "Michelangelo", value: "In the style of Michelangelo, Render the human form with idealized, colossal musculature (terribilità), emphasizing dramatic contrapposto, complex torsional poses, and a sculptural sense of volume and energy." },
                { display: "Pablo Picasso", value: "In the style of Pablo Picasso, Generate images by fragmenting subjects into multiple geometric planes (Cubism), employing simultaneous viewpoints, and using a structural, often monochromatic or reduced palette for analysis or collage." },
                { display: "Claude Monet", value: "In the style of Claude Monet, Recreate the transient quality of light and atmosphere by applying paint in visible, broken brushstrokes (Impasto), focusing on the optical mixing of pigment, and depicting a single subject in series under varied conditions." },
                { display: "Jackson Pollock", value: "In the style of Jackson Pollock, Create large, 'all-over' abstract compositions by dripping, pouring, and flinging industrial paint onto a horizontal canvas, resulting in a dense, layered network of linear skeins without a central focus." },
                { display: "Georgia O'Keeffe", value: "In the style of Georgia O'Keeffe, Execute large-scale, close-up details of natural forms, like flowers or bones, using smooth, gradient transitions of value, simplified contours, and a composition that borders on pure abstraction." },
                { display: "Vincent van Gogh", value: "In the style of Vincent van Gogh, Apply paint with an emotionally intense impasto, utilizing distinct, swirling, curvilinear brushstrokes that convey movement and energy, and employing thick application often within dark contours." },
                { display: "Johannes Vermeer", value: "In the style of Johannes Vermeer, Achieve photorealistic detail in intimate, domestic scenes by rendering light with scientific precision (often using pointillés for highlights), and focusing on subtle textures and harmonious spatial composition." },
                { display: "Andy Warhol", value: "In the style of Andy Warhol, Replicate iconic commercial imagery and celebrity photographs using mass-production methods like silkscreen printing, characterized by flat blocks and repetitive, modular arrangements." },
                { display: "Cezanne", value: "In the style of Cezanne, Construct subjects using visible, parallel, faceted brushstrokes that build up geometric forms, resulting in a deliberate distortion of perspective, and an emphasis on the underlying structural volume of nature." },
                { display: "Gustav Klimt", value: "In the style of Gustav Klimt, Compose figures in a highly stylized, flat manner, often incorporating intricate, Byzantine-inspired patterns and application of metallic leaf that merge the subject and background into an ornate, sensual tapestry." },
                { display: "Rembrandt van Rijn", value: "In the style of Rembrandt van Rijn, Masterfully use dramatic chiaroscuro (pronounced light and shadow) to sculpt figures out of darkness, focusing on visceral texture and a somber palette to convey profound psychological depth and human vulnerability." },
                { display: "Salvador Dalí", value: "In the style of Salvador Dalí, Paint hallucinatory, dream-like landscapes with academic, almost photographic realism, juxtaposing precise, hard-edged detail with bizarre, symbolic, and often unsettling melting or suspended objects." }
            ],
            "Or an Art Style": [
                { display: "Impressionism", value: "In the style of impressionism, broad, visible short brushstrokes, light focused, loose forms, en plein air and outdoors to capture the fleeting effects of natural light, depicting everyday subjects and scenes of modern life, a sense of spontaneity, an emphasis on capturing a momentary impressions, and open compositions with unusual visual angles." },
                { display: "Abstract Art", value: "In the style of abstract art, non-representational forms, geometric and organic shapes, non-representational nature, emphasis on visual elements like shape and form and line, focus on emotion and concepts over realistic depiction, use visual language instead of showing recognizable objects to evoke feelings and ideas and spiritual themes, subjective interpretation." },
                { display: "Surrealism", value: "In the style of surrealism, dreamlike imagery, illogical irrational juxtaposition, unexpected elements, use of techniques like automatism to tap into the subconscious, combining unrelated objects in surprising ways, depicting strange or impossible scenes, employing symbolism to explore the human psyche, rejecting rationality and order in favor of the unpredictable nature of the mind." },
                { display: "Cubism", value: "In the style of cubism, a revolutionary early 20th-century art movement pioneered by Pablo Picasso and Georges Braque that completely reimagined traditional Western art conventions. It rejected the idea that art should imitate nature or use a single, fixed perspective, focusing instead on depicting subjects from multiple viewpoints simultaneously within a single composition." },
                { display: "Pop Art", value: "In the style of pop art, bold, graphic, thick black outlines, commercial imagery, mass consumerism and everyday life, celebrity culture, irony and satire, hard-edged composition, typography, postmodernism." }
            ]
        };
        // *** CORE CONFIG & DOM ELEMENTS ***
        const N8N_WEBHOOK_URL = 'https://steak.servequake.com/webhook-test/0d799bc0-9a8f-4da0-a9a0-39e511d5d01d';
        // CHANGED: Increased max file size to 7MB
        const MAX_FILE_SIZE_BYTES = 7 * 1024 * 1024; // 7MB
        // NEW CONSTANT: For placeholder image
        const PLACEHOLDER_THUMBNAIL_URL = 'https://github.com/masoudassali/TLC/blob/main/Thumbnail%20Placeholder.png?raw=true';
        // Global variable to store the 'pure' manual text, excluding currently applied presets
        let manualTextBase = "";                
        
        // FIX 1A: Define the mutually exclusive groups using the space-removed names
        const EXCLUSIVE_GROUPS = ['InfluentialArtists', 'OranArtStyle'];

        // Wrap initialization so it runs after DOM is ready        
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('imageGenerationForm');
            const promptTextarea = document.getElementById('prompt');
            const placeholderText = document.getElementById('placeholderText');
            const generatedImage = document.getElementById('generatedImage');
            const submitButton = form.querySelector('button');
            const presetsContainer = document.getElementById('presetsContainer');
            const statusBar = document.getElementById('statusBar');
            const statusMessage = document.getElementById('statusMessage');                        
            const imageUpload = document.getElementById('imageUpload');
            const imagePreview = document.getElementById('imagePreview'); // Correctly reference the img element
            const imagePreviewContainer = document.getElementById('imagePreviewContainer');

            // Status Bar Steps
            const STATUS_STEPS = [
                "5% - Sending your descriptions to our magician, Tony ...",
                "18% - Tony received your descriptions. Now figuring out the style...",
                "22% - Tony is adding the final touches...",
                "41% - This may take 5-15 seconds...",
                "67% - Converting everything into a PNG file...",
                "93% - Sending image data back to your browser...",
                "100% - Serving up your order now..."
            ];
            
            // Status Bar Control
            let statusInterval;
            function updateStatus(start) {
                if (!start) {
                    clearInterval(statusInterval);
                    statusBar.classList.remove('visible');
                    return;
                }
                let stepIndex = 0;
                statusBar.classList.add('visible');
                const cycleStatus = () => {
                    statusMessage.innerHTML = STATUS_STEPS[stepIndex];
                    stepIndex = (stepIndex + 1) % STATUS_STEPS.length;
                    // Freeze on the main generation step (41%) for longer
                    if (stepIndex === 4) stepIndex = 3;
                };
                cycleStatus();
                statusInterval = setInterval(cycleStatus, 3000);
            }
            
            // Function to render the presets dynamically
            function renderPresets() {
                let html = '';
                // Note: Object.keys() preserves insertion order in modern JS environments
                for (const categoryName in PRESET_CATEGORIES) {
                    const categoryData = PRESET_CATEGORIES[categoryName];
                    const radioGroupName = categoryName.replace(/\s/g, ''); 
                    
                    html += `<div class="preset-category"><h4>${categoryName}</h4>`;
                    if (Array.isArray(categoryData)) { 
                         categoryData.forEach(item => {
                            // data-group uses the space-removed radioGroupName
                            html += `
                                <label>
                                    <input type="radio" 
                                           name="${radioGroupName}" 
                                           value="${escapeHtml(item.value)}" 
                                           data-group="${radioGroupName}">
                                    ${escapeHtml(item.display)}
                                </label>
                            `;
                        });
                    }
                    html += `</div>`;
                }
                presetsContainer.innerHTML = html;
                
                // Attach event listener to ALL radio buttons (dynamically generated and static 'busyness')
                document.querySelectorAll('input[type="radio"]').forEach(radio => {
                    
                    // Check if the radio button belongs to one of the exclusive groups
                    if (EXCLUSIVE_GROUPS.includes(radio.getAttribute('data-group'))) {
                        radio.addEventListener('change', handleExclusiveSelection);
                    }
                    
                    // Busyness radio buttons are independent, just update the prompt box
                    if (radio.name === 'busyness') {
                        radio.addEventListener('change', updatePromptBox);
                    }
                });
            }                        
            
            // NEW FUNCTION: Handles the exclusive selection logic
            function handleExclusiveSelection(event) {
                const clickedRadio = event.target;
                // clickedGroup is the space-removed name (e.g., 'InfluentialArtists')
                const clickedGroup = clickedRadio.getAttribute('data-group');                                
                
                // Find the other exclusive group's name
                const otherGroup = EXCLUSIVE_GROUPS.find(group => group !== clickedGroup);                                
                
                if (otherGroup) {
                    // Uncheck all radio buttons in the other group
                    document.querySelectorAll(`input[name="${otherGroup}"]:checked`).forEach(radio => {
                        radio.checked = false;                    
                    });
                }
                // Update the prompt box after making changes
                updatePromptBox();            
            }

            // Escape HTML helper
            function escapeHtml(str) {
                return String(str)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '');             
            }                         
            
            // Function to update manualTextBase ONLY on user typing
            function updateManualTextBaseOnly(event) {
                let fullText = promptTextarea.value.trim();                                 
                const activePresetValues = [];                                
                
                // Collect values from exclusive groups
                // FIX 1A/2: EXCLUSIVE_GROUPS contains the correct radio button names (e.g., 'OranArtStyle')
                EXCLUSIVE_GROUPS.forEach(radioName => {
                    const value = document.querySelector(`input[name="${radioName}"]:checked`)?.value;
                    if (value) activePresetValues.push(value);
                });
                
                // Collect value from busyness group
                const busynessValue = document.querySelector('input[name="busyness"]:checked')?.value || '';
                if (busynessValue) activePresetValues.push(busynessValue);
                 
                let base = fullText;
                 
                // Strip out preset values
                activePresetValues.filter(v => v).forEach(preset => {
                    const escapedPreset = preset.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                    const regex = new RegExp(`, ${escapedPreset}|${escapedPreset}, ?`, 'g');
                    base = base.replace(regex, '');
                });
                 
                base = base.split(',').map(s => s.trim()).filter(s => s).join(', ');
                 
                manualTextBase = base;
                 
                updatePromptBox();
            }

            // Function to update the prompt box with manual text + selected presets
            function updatePromptBox(event) {
                 
                let combinedPromptParts = [];
                 
                if (manualTextBase) {
                    combinedPromptParts.push(manualTextBase);
                }
                 
                // 1. Get the single selected value from the exclusive groups (only one can be checked)
                // FIX 1A/2: Ensure we iterate over the correct radio button names
                EXCLUSIVE_GROUPS.forEach(radioName => {
                    const exclusiveValue = document.querySelector(`input[name="${radioName}"]:checked`)?.value;
                    if (exclusiveValue) combinedPromptParts.push(exclusiveValue);
                });

                // 2. Get the busyness value (independent)
                const busynessValue = document.querySelector('input[name="busyness"]:checked')?.value || '';
                if (busynessValue) combinedPromptParts.push(busynessValue);


                // Update the prompt box.
                promptTextarea.value = combinedPromptParts.filter(p => p).join(', ');
            }


            // Initialize the UI elements
            renderPresets();
             
            // Set initial state
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.checked = false;
            });
            promptTextarea.value = '';

            // Update event listener on textarea: Now calls the base tracking function
            promptTextarea.addEventListener('input', updateManualTextBaseOnly); 

             
            // UPDATED image handler to manage the placeholder and show chosen thumbnail
            imageUpload.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const validTypes = ['image/png', 'image/jpeg', 'image/jpg'];
                    // Accept TIFF for upload, but do not preview
                    if (!validTypes.includes(file.type)) {
                        if (file.type === 'image/tiff' || file.type === 'image/x-tiff') {
                            imagePreview.src = PLACEHOLDER_THUMBNAIL_URL;
                            imagePreview.alt = "TIFF preview not supported";
                            return;
                        } else {
                            alert('Invalid file type. Please upload a PNG, JPEG, or TIFF image.');
                            e.target.value = '';
                            imagePreview.src = PLACEHOLDER_THUMBNAIL_URL;
                            imagePreview.alt = "Uploaded Image Preview";
                            return;
                        }
                    }
                    if (file.size > MAX_FILE_SIZE_BYTES) {
                        // UPDATED alert message
                        alert(`File size exceeds 7MB limit. Please upload a smaller image.`);
                        e.target.value = '';
                        imagePreview.src = PLACEHOLDER_THUMBNAIL_URL;
                        imagePreview.alt = "Uploaded Image Preview";
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = function(ev) {
                        imagePreview.src = ev.target.result;
                        imagePreview.alt = "Selected Image Thumbnail";
                    };
                    reader.readAsDataURL(file);
                } else {
                    imagePreview.src = PLACEHOLDER_THUMBNAIL_URL;
                    imagePreview.alt = "Uploaded Image Preview";
                }
            });

            // ** FORM SUBMISSION LOGIC **
            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const prompt = promptTextarea.value.trim();
                const imageFile = imageUpload.files[0];

                if (!imageFile) {
                    alert("An image upload is required to generate the outline.");
                    return;
                }

                // 1. Update UI for 'Loading' state
                submitButton.textContent = "Tony's cooking... Please wait.";
                submitButton.disabled = true;
                placeholderText.textContent = 'Generating your unique outline...';
                placeholderText.style.display = 'block';
                generatedImage.style.display = 'none';

                // START STATUS BAR
                updateStatus(true);

                try {
                    let finalImageBlob = imageFile;
                    
                    const formData = new FormData();
                    formData.append('prompt', prompt); 
                    // N8n expects the binary file to be named 'image'
                    formData.append('image', finalImageBlob, imageFile.name); 

                    const response = await fetch(N8N_WEBHOOK_URL, {
                        method: 'POST',
                        body: formData,
                        // DO NOT set Content-Type header when using FormData
                    });

                    // 2. Handle response
                    if (response.ok) {
                        const contentType = response.headers.get('content-type');
                        
                        // Check for JSON error response
                        if (contentType && contentType.includes('application/json')) {
                            const result = await response.json();
                            throw new Error(`Server Error (JSON Response): ${result.errorMessage || JSON.stringify(result)}`);
                        }
                        
                        // Assume successful image blob response
                        const blob = await response.blob();
                        const imageUrl = URL.createObjectURL(blob);
                        
                        generatedImage.src = imageUrl;
                        generatedImage.style.display = 'block';
                        placeholderText.style.display = 'none';
                    } else {
                        // Attempt to read error message from response body
                        const errorText = await response.text();
                        throw new Error(`HTTP Error: ${response.status} - ${errorText.substring(0, 100)}...`);
                    }
                } catch (error) {
                    console.error('Generation failed:', error);
                    placeholderText.textContent = `Sorry, Tony failed to cook this time. Error: ${error.message}`;
                    placeholderText.style.display = 'block';
                    generatedImage.style.display = 'none';
                } finally {
                    // 3. Reset UI state
                    updateStatus(false);
                    submitButton.textContent = "Ok Tony, cook me an amazing outline...";
                    submitButton.disabled = false;
                }
            });
        });
    </script>
</body>
</html>
